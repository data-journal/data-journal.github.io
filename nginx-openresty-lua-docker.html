<html lang="en"><head><meta content="width=device-width, initial-scale=1, maximum-scale=1" name="viewport" /><meta content="Openresty lets you extend Nginx with Lua, a lightweight, embedded language. Setting the dev environment is time consuming when Openresty is compiled locally, making collaboration harder. This, together with the fact that Nginx and Lua don&apos;t get the attention they should get sets the motivation for this blog post. I&apos;ll show you some tools to set up nginx with Lua, so that you have everything you need to start hacking with server side Lua." name="description" /><title>Data Journal - A development environment for a tricked out Nginx</title><link href="assets/css/font.css" rel="stylesheet" /><link href="//maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css" rel="stylesheet" /><link href="assets/css/style.css" rel="stylesheet" /><link href="assets/css/github.css" rel="stylesheet" /><link href="//cdn-images.mailchimp.com/embedcode/slim-081711.css" rel="stylesheet" type="text/css" /><script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-MML-AM_CHTML" type="text/javascript"></script></head><body><div class="source" id="desktop-source"><a href="https://github.com/data-journal/data-journal.github.io" target="_blank">Source</a></div><div id="side-bar"><div class="menu-modal" id="menu-modal"><div class="modal-content"><span class="menu-close">×</span><div class="modal-menu-items"><a href="nginx-openresty-lua-docker.html"><span class="modal-nav-item-title">Ngix Lua</span></a><span class="modal-nav-item-date">(2017-08-01)</span><br /><a href="nginx-openresty-lua-docker.html"><span class="modal-nav-item-title">Nginx Lua</span></a><span class="modal-nav-item-date">(2017-08-01)</span><br /><a href="clojure-language-pitfalls.html"><span class="modal-nav-item-title">Language Fundamentalism</span></a><span class="modal-nav-item-date">(2017-07-13)</span><br /><a href="open-data.html"><span class="modal-nav-item-title">Open Data</span></a><span class="modal-nav-item-date">(2016-10-10)</span><br /><a href="cellular-automata.html"><span class="modal-nav-item-title">Cellular Automata</span></a><span class="modal-nav-item-date">(2015-06-21)</span><br /><a href="webrtc-part-2.html"><span class="modal-nav-item-title">Webrtc Part 2</span></a><span class="modal-nav-item-date">(2015-03-20)</span><br /><a href="webrtc-part-1.html"><span class="modal-nav-item-title">Webrtc Part 1</span></a><span class="modal-nav-item-date">(2015-02-27)</span><br /></div></div></div><button id="menu-btn"><i aria-hidden="true" class="fa fa-bars"></i></button><div id="header"><div id="title"><a href="/">Data Journal</a></div><div id="author"><div id="name">Flávio Sousa</div><div id="social-media"><a href="//pt.linkedin.com/pub/flávio-sousa/3a/a06/770/" target="_blank"><i class="fa fa-linkedin"></i></a><a href="//twitter.com/verysocialsousa" target="_blank"><i class="fa fa-twitter"></i></a><a href="//github.com/fjsousa" target="_blank"><i class="fa fa-github"></i></a></div></div></div><div id="menu"><a href="nginx-openresty-lua-docker.html"><span class="nav-item-title">Ngix Lua</span></a><span class="nav-item-date">2017-08-01</span><br /><a href="nginx-openresty-lua-docker.html"><span class="nav-item-title">Nginx Lua</span></a><span class="nav-item-date">2017-08-01</span><br /><a href="clojure-language-pitfalls.html"><span class="nav-item-title">Language Fundamentalism</span></a><span class="nav-item-date">2017-07-13</span><br /><a href="open-data.html"><span class="nav-item-title">Open Data</span></a><span class="nav-item-date">2016-10-10</span><br /><a href="cellular-automata.html"><span class="nav-item-title">Cellular Automata</span></a><span class="nav-item-date">2015-06-21</span><br /><a href="webrtc-part-2.html"><span class="nav-item-title">Webrtc Part 2</span></a><span class="nav-item-date">2015-03-20</span><br /><a href="webrtc-part-1.html"><span class="nav-item-title">Webrtc Part 1</span></a><span class="nav-item-date">2015-02-27</span><br /></div><div id="footer-bar"><div id="mc_embed_signup"><div class="rss-feed"><a href="/feed.xml"><i aria-hidden="true" class="fa fa-rss"></i></a></div><form action="//github.us10.list-manage.com/subscribe/post?u=5b26850668dc6b3f84778ca5e&amp;id=cb5f4eedfe" class="validate" id="mc-embedded-subscribe-form" method="post" name="mc-embedded-subscribe-form" novalidate="" target="_blank"><div id="mc_embed_signup_scroll"><label for="mce-EMAIL">Subscribe to the mailing list</label><input class="email" id="mce-EMAIL" name="EMAIL" placeholder="email address" required="" type="email" value="" /><div style="position: absolute; left: -5000px;"><input name="b_5b26850668dc6b3f84778ca5e_cb5f4eedfe" tabindex="-1" type="text" value="" /></div><div class="clear"><input class="button" id="mc-embedded-subscribe" name="subscribe" type="submit" value="Subscribe" /></div><div class="source" id="mobile-source"><a href="https://github.com/data-journal/data-journal.github.io" target="_blank">Source</a></div></div></form></div><div id="about"><p id="about-title">About:</p><p>A place for tech and numerical experimentalism. Be welcome.</p></div></div></div><div id="container"><div id="content"><div><h1>A development environment for a tricked out Nginx</h1><h3>TL,DR: A docker based development environment for scripting in nginx. Clone, build, run and try it for yourself:</h3><ul><li><code>$ git clone git@github.com:fjsousa/openresty-smart-proxy.git</code></li><li><code>$ cd openresty-smart-proxy/</code></li><li><code>$ docker build -t nginx-barrier-page:latest .</code></li><li><code>$ docker run -p 80:80 nginx-barrier-page:latest</code></li><li>hit <code>localhost</code> in your browser</li></ul><p>At Style.com, prior to our Setember 2016 launch, we published a Beta version of our website in May. We wanted to have a barrier page on the <code>style.com</code> domain, that would require an invitation token. If valid it would set a cookie with a token that would be used in every following request to bypass the barrier page. The tokens could be invalidated and would expire after a certain time.</p><p>The business rules required a solution more sophisticated than what Nginx provided out of the box and this provided the perfect oportunity to roll out Openresty with a custom Lua script. OpenResty is an extended version of Nginx with a it has a module that lets you embed Lua scripts. We had heard wonders of Lua + Openresty <a href="https://githubengineering.com/rearchitecting-github-pages/">performance</a> and witnessed the small overhead <a href="https://getkong.org/">Kong</a> added to our requests. Also, Nginx was already part of our stack acting as a reverse proxy and doing https offloading. This proved to be the perfect solution blablabla</p><p>To start scripting in Nginx using Lua, use it, you just need to download and compile OpenResty, then in your Nginx server configuration, you need to add a <code>access_by_lua_file</code> directive, and the path to the Lua file:</p><pre><code>server {
  listen 80;
  server_name smartproxy

  location / {
    access_by_lua_file path/main.lua;
    proxy_pass some.website.com;
  }

}
</code></pre><p>This configuration, for instance, would listen in the port <code>80</code> and proxy <code>some.website.com</code> according to some custom logic in the Lua script. Going from plain Nginx to Scripting with Lua that's it. However there's a setup overhead and getting a development environment up and running is not strightforward. That's the objective of this blog post.</p><p>Setting up a local dev env is trick as you need to have openresty and Lua Rocks, Lua's package manager. After a couple of tries I got a dev env working based on docker. That's what I'll show. In this blog post I'll give you everything you need to start deveoping and being productive with Nginx and Lua.</p><h2>1 Dockerfile</h2><p>I've prepared an <a href="https://hub.docker.com/r/fjsousa/nginx-openresty/">open resty base image</a> based on Alpine Linux. The image has around 17 MB and is based on this other <a href="https://github.com/ficusio/openresty/blob/master/alpine/Dockerfile">OpenResty Image</a> but with LuaRocks and an up to date version of openresty. This is the break down of the Dockerfile. You can find the complete web app here: https://github.com/fjsousa/openresty-smart-proxy.</p><h3>Install Lua dependencies</h3><pre><code>RUN apk update \
 &amp;&amp; apk add --virtual build-deps \
    unzip wget curl gcc make musl-dev \
    pcre-dev openssl-dev zlib-dev \
    ncurses-dev readline-dev perl \
  &amp;&amp; echo &quot;==&gt; Installing Lua dependencies...&quot; \
 &amp;&amp; luarocks install busted \
 &amp;&amp; luarocks install lua-resty-http \
 &amp;&amp; rm -rf /root/luarocks
</code></pre><p>Because we're using a lightweight Alpine Linux base image, we'll have to install some dependencies taken for granted in other systems, like GCC, CURL AND WGET. We name them BUILD-DEPS so that we can refer to them back later and delete them in case you want a production ready system.</p><p>The other dependencies are LuaRocks, Lua packages, for unit testing, BUSTED, and and https client, LUARESTYHTTP</p><h3>Carry over assets, Nginx config files, Lua files</h3><pre><code>RUN mkdir -p /opt/openresty/nginx/nginx-server/logs
COPY nginx-server/conf /opt/openresty/nginx/nginx-server/conf
COPY nginx-server/lualib /opt/openresty/nginx/nginx-server/lualib
COPY public /opt/openresty/nginx/nginx-server/public

</code></pre><p>This copies all files to the container.</p><h3>Set env vars and replace fill templates</h3><pre><code>RUN echo &quot;==&gt; Replacing nginx *.tmpl files...&quot;
ENV NGINX_CONFIG /opt/openresty/nginx/nginx-server/conf/nginx
ENV SERVER_CONFIG /opt/openresty/nginx/nginx-server/conf/servers/server
ENV COOKIE_NAME Token
ENV URL http://www.theuselessweb.com/
ENV COOKIE_DOMAIN localhost
</code></pre><pre><code>RUN cp &quot;$NGINX_CONFIG&quot;.tmpl &quot;$NGINX_CONFIG&quot;.conf \
 &amp;&amp; cp &quot;$SERVER_CONFIG&quot;.tmpl &quot;$SERVER_CONFIG&quot;.conf \
 &amp;&amp; sed -i -- &quot;s|{{COOKIE_NAME}}|$COOKIE_NAME|g&quot; $NGINX_CONFIG.conf \
 &amp;&amp; sed -i -- &quot;s|{{COOKIE_DOMAIN}}|$COOKIE_DOMAIN|g&quot; $NGINX_CONFIG.conf \
 &amp;&amp; sed -i -- &quot;s|{{URL}}|$URL|g&quot; $SERVER_CONFIG.conf

</code></pre><p>We copy the templates to the configuration files  and replace the placeholder with the values defined for each env variable, defined on the Dockerfile.</p><h3>Del build dependencies and run Nginx</h3><p>If you want to make the image as small as possible and ready for production, delete the build dependencies. Otherwise keep them, these basic commands will be useful for debugging.</p><pre><code>RUN apk del build-deps

CMD [&quot;nginx&quot;, &quot;-g&quot;, &quot;daemon off; error_log /dev/stderr info;&quot;, &quot;-p&quot;, &quot;nginx-server/&quot;, &quot;-c&quot;, &quot;conf/nginx.conf&quot;]

</code></pre><h2>2 Development Flow</h2><p>  A development flow would go like this</p><ul><li>Code changes</li><li><code>docker build -t nginx-barrier-page:latest .</code></li><li><code>docker run -p 80:80 nginx-barrier-page:latest</code></li><li>Repeat</li></ul><p>The whole process should be quite fast. Building the image, carrying over the source files, starting Nginx, should be around 1 second. You can even have a file watcher monitoring the source file and triggering the docker build and run commands. If you're using a native docker you might be able to just mount the source folder if you wish too.</p><h2>3 Example time</h2><p>As an example, imagine you have a website that you want to protect with a password screen. Lets use <code>http://www.theuselessweb.com/</code> as our target website because I've been procrastinating while writing this post. However, you want something custom, other than the basic authentication that Nginx can provide.</p><p>We want the user to see a barrier form prompting a token. When the user sends the token, we want to validate it against a list of valid tokens. If the token is valid, we'll store a domain cookie with the token so that next time, the cookie in the headers is validated instead. If the token is invalidated in the server side, the user is served the form instead of the website he wishes to see.</p><p><img alt="Barrier Page http flow" src="assets/img/bits-and-pieces/barrier-page-flow.jpg" title="Barrier Page http flow" /></p><p>Our proxy will have the proxy logic at <code>/</code>, meaning that every request that starts with <code>/</code> will go trough the respective configuration block. Also, the <code>/auth</code> endpoind which will handle the token authentication posted by the authentication form at the barrier page.</p><pre><code>server {
  listen 80;
  server_name smartproxy;

  location / {
    resolver 8.8.8.8;
    access_by_lua_file lualib/main.lua;
    proxy_pass http://www.theuselessweb.com/;
  }

  location = /auth {
    resolver 8.8.8.8;
    lua_need_request_body on;
    access_by_lua_file lualib/auth.lua;
  }

  location = /form.html {
    root public;
  }

  location /form {
    include mime.types;
    root public;
  }

}

</code></pre><p><code>main.lua</code> Takes the token from the cookie in the request and checks its validity with <code>isvalid.lua</code>. When invalid, return the barrier page <code>form.html</code> as a response to the initial request. If valid, the script just returns, and the Nginx directive. The important thing to notice is that each request, not only the html under <code>http://www.theuselessweb.com/</code> but also every asset, will go through this validation step. Which is why it's so important for this step to be performant.</p><pre><code>local is_valid = require &quot;nginx-server/lualib/isvalid&quot;
local cookie_name = os.getenv(&quot;COOKIE_NAME&quot;)
local token_cookie = ngx.var[&quot;cookie_&quot; .. cookie_name]

ngx.log(ngx.INFO, &quot;Checking validity for cookie token: &quot; .. (token_cookie or &quot;nil&quot;))

if not is_valid(token_cookie) then
  ngx.log(ngx.INFO, &quot;Cookie token not valid: &quot; .. (token_cookie or &quot;nil&quot;))
  return ngx.exec(&quot;/form.html&quot;)
end

ngx.log(ngx.INFO, &quot;Cookie token valid: &quot; .. (token_cookie or &quot;nil&quot;))
return

</code></pre><p><code>auth.lua</code> also checks if the token is valid using the same function <code>isvalid.lua</code> returning 401 if not and redirecting the user to <code>/</code> after setting the cookie.</p><pre><code>local is_valid = require &quot;nginx-server/lualib/isvalid&quot;
local cookie_name = os.getenv(&quot;COOKIE_NAME&quot;)
local cookie_domain = os.getenv(&quot;COOKIE_DOMAIN&quot;)
local user_code, err = ngx.req.get_post_args(1)[&quot;code&quot;]

ngx.log(ngx.INFO, &quot;Checking validity for auth token: &quot; .. (user_code or &quot;nil&quot;))

local valid = is_valid(user_code)

if valid == false then
  ngx.log(ngx.INFO, &quot;Auth token not valid: &quot; .. user_code)
  ngx.status = 401
  ngx.header[&quot;Content-type&quot;] = &quot;text/html&quot;
  ngx.say(&quot;Unauthorized. Take me to the &lt;a href=\&quot;/\&quot;&gt;main page.&lt;/a&gt;&quot;)
  return
end

ngx.log(ngx.INFO, &quot;Auth token is valid: &quot; .. user_code)
ngx.log(ngx.INFO, &quot;Setting domain cookie&quot;)
ngx.header['Set-Cookie'] = cookie_name .. &quot;=&quot; .. valid .. &quot;; Domain=&quot; .. cookie_domain
ngx.redirect(&quot;/&quot;)
return
 
</code></pre><p>Notice that the script is using a set of Nginx functionalities as an api (<code>ngx</code>). You can read more about this extensive api in the <a href="https://github.com/openresty/lua-nginx-module#nginx-api-for-lua">github page</a>.</p><p>If you want to get started with this setup just <a href="https://github.com/fjsousa/openresty-smart-proxy">clone the repo</a> build it and run it <code>docker build -t nginx-barrier-page:latest .</code> <code>docker run -p 80:80 nginx-barrier-page:latest</code></p><h2></h2><p>Further Reading</p><ul><li>http://www.staticshin.com/top-tens/things-about-openresty.html</li><li>https://openresty.org/en/lua-nginx-module.html</li></ul></div><a class="twitter-share-button" data-size="large" data-via="fjmarujo" href="https://twitter.com/share">Tweet<script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script></a><div id="disqus_thread"><script type="text/javascript">/* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
var disqus_shortname = 'this-data'; // required: replace example with your forum shortname
/* * * DON'T EDIT BELOW THIS LINE * * */
(function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();</script><noscript>Please enable JavaScript to view the<a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript></div></div></div><div id="footer"></div><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-53583095-1', 'auto');
  ga('send', 'pageview');
</script><script src="//code.jquery.com/jquery-1.11.2.min.js"></script><script src="assets/src/modal.js" type="text/javascript"></script><script src="assets/src/highlight.pack.js" type="text/javascript"></script><script>hljs.initHighlightingOnLoad();</script><script src="assets/src/rags.js" type="text/javascript"></script><script src="assets/src/fgm-main.js" type="text/javascript"></script></body></html>